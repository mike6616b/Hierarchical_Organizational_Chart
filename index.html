<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>組織架構圖 MVP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    :root { --bg:#f5f6fa; --card:#fff; --ink:#2c3e50; --muted:#7f8c8d; }
    *{box-sizing:border-box}
    body {
          margin: 0;
          font-family: 'Noto Sans TC', 'Microsoft JhengHei',system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
          background: var(--bg);
    }
    .container{max-width:1400px;margin:16px auto;background:var(--card);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.08);overflow:hidden}
    .header{position:relative;padding:20px;color:#fff;background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%)}
    .header h1{margin:0 0 6px;font-size:22px}
    .header p{margin:0;opacity:.9}
    .date-filter{position:absolute;top:16px;right:16px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(10px);border-radius:10px;padding:10px}
    .date-filter input[type="date"],.date-filter input[type="text"]{width:160px;padding:8px;border:none;border-radius:6px;background:rgba(255,255,255,.95);font-size:12px}
    .date-filter button{padding:8px 12px;border:none;border-radius:6px;background:#27ae60;color:#fff;font-size:12px;cursor:pointer}
    .chart-container { padding:16px; text-align:center; position:relative; }
    .instructions{background:linear-gradient(135deg,#e8f5e8 0%,#f0f8ff 100%);border:1px solid #27ae60;color:var(--ink);padding:12px;border-radius:10px;margin:0 0 12px;font-size:13px}
    .stats-summary{display:flex;justify-content:space-around;gap:8px;flex-wrap:wrap;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:14px;border-radius:10px;margin-top:12px}
    .stat-item{text-align:center}.stat-value{font-size:22px;font-weight:800;display:block}.stat-label{font-size:12px;opacity:.9}
    .node circle{stroke-width:2px;transition:all .25s ease}.node circle:hover{transform:scale(1.08)}
    .node text{fill:var(--ink);text-anchor:middle;pointer-events:none}
    .name-text{font-weight:700;font-size:14px;dominant-baseline:middle}
    .level-text{font-size:11px;color:var(--muted);dominant-baseline:middle}
    .orders-text{font-size:10px;fill:#27ae60;font-weight:700;dominant-baseline:middle}
    .pickup-text{font-size:10px;fill:#8e44ad;font-weight:700;dominant-baseline:middle}
    .link{fill:none;stroke:#bdc3c7;stroke-width:2px;stroke-opacity:.85}

    /* --- Zoom/Pan 視覺與尺寸 --- */
    #chart svg{ width:100%; height:70vh; display:block; cursor:grab;}
    #chart svg.grabbing{ cursor:grabbing; }
    #chart { position: relative; }              /* 讓子元素可用 absolute 對齊 */
    #zoomControls{
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      z-index: 3;                               
    }
    #zoomControls button{
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
    }
    #btnFit{ display:none; }                    /* 暫時隱藏 Fit */
    
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>組織架構圖</h1>
      <p>點擊節點展開下線組織，查看各階段業績表現</p>
      <div class="date-filter">
        <input type="date" id="startDate" value="2025-01-01" />
        <input type="date" id="endDate" value="2025-08-15" />
        <button id="btnApply">更新數據</button>
        <input type="text" id="searchName" placeholder="搜尋人名" />
        <button id="btnSearch"  style="background:#3b82f6">搜尋</button>
        <button id="btnClear"   style="background:#f51111">清除</button>
        <button id="btn-expand" style="background:#6b7280">展開</button>
      </div>
    </div>

    <style>
      .dot { display:inline-block; width:12px; height:12px; border-radius:50%; border:2px solid; vertical-align:middle; }
      .dot-dealer { background:#5582b4; border-color:#3f668e; }   /* 經銷商 */
      .dot-level  { background:#f7959d; border-color:#d86a74; }   /* 高/中/初級 */
      .dot-normal { background:#deabe9; border-color:#b687c8; }   /* 一般 */
      .dot-high   { background:#ffffff; border-color:#fff600; }   /* 高業績 */
    </style>
    
    <div class="chart-container">
      <div class="instructions">
        使用日期區間與搜尋人名<br>
        等級配色：
        <div>
          <span class="dot dot-dealer"></span> 經銷商　
          <span class="dot dot-level"></span> 高/中/初級　
          <span class="dot dot-normal"></span> 一般　
          <span class="dot dot-high"></span> 高業績（月均訂貨 ≥ 106萬）
        </div>
      </div>
        
      <div id="chart">
        <div id="zoomControls">
          <button id="btnZoomIn">＋</button>
          <button id="btnZoomOut">－</button>
          <button id="btnFit">Fit</button>
       </div>
      </div>
      
      <div class="stats-summary">
        <div class="stat-item"><span class="stat-value" id="totalOrders">0</span><span class="stat-label">總訂貨金額 (萬元)</span></div>
        <div class="stat-item"><span class="stat-value" id="totalPickup">0</span><span class="stat-label">總提貨金額 (萬元)</span></div>
        <div class="stat-item"><span class="stat-value" id="totalMembers">0</span><span class="stat-label">組織總人數</span></div>
        <div class="stat-item"><span class="stat-value" id="highPerformers">0</span><span class="stat-label">高業績會員</span></div>
      </div>
    </div>

  <script>
    // ------- Mock data -------
function generateOrgTree(opts = {}) {
  const {
    seed = Date.now(),              // 固定種子可重現結果
    dealers = 3,                    // 經銷商數量（ROOT 下一層）
    depth = 10,                      // 最大深度（含 ROOT 層）
    // 各層分支數範圍（最小, 最大），從 經銷商 → 高級 → 中級 → 初級 → 一般
    branching = {
      dealer: [3, 6],               // 經銷商底下的「高級/中級起點」數
      senior: [4, 8],               // 高級底下的中級/初級數
      mid:    [2, 7],               // 中級底下的初級/一般數
      junior: [1, 6],               // 初級底下的一般數
      general:[0, 0],               // 一般為葉節點
    },
    // 各層績效區間與提貨比（pickup 相對訂貨，確保 ≤ 訂貨）
    perfByLevel = {
      ROOT:      { order:[0,0],    pickupRatio:[0,0] },
      經銷商:     { order:[350,500], pickupRatio:[0.55,0.9] },
      高級:       { order:[120,220], pickupRatio:[0.4,0.9] },
      中級:       { order:[60,110],  pickupRatio:[0.45,0.9] },
      初級:       { order:[40,80],   pickupRatio:[0.3,0.85] },
      一般:       { order:[18,40],   pickupRatio:[0.5,0.8] },
    }
  } = opts;

  // --- PRNG: mulberry32 + 簡單 seed hash ---
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
  const rnd = mulberry32(hashSeed(seed));
  function hashSeed(s){ if(typeof s==='string'){let h=2166136261>>>0; for(let i=0;i<s.length;i++){h^=s.charCodeAt(i); h=Math.imul(h,16777619)} return h>>>0 } return s>>>0 }

  // --- Helpers ---
  const pick = arr => arr[Math.floor(rnd()*arr.length)];
  const randInt = (min,max)=>Math.floor(rnd()*(max-min+1))+min;
  const randFloat = (min,max)=>rnd()*(max-min)+min;
  const idCounters = new Map();
  const nextId = prefix => { const n=(idCounters.get(prefix)||0)+1; idCounters.set(prefix,n); return prefix+String(n).padStart(3,'0'); };

  // 中文姓名片段（可擴充）
  const lastNames = '李王張劉陳楊黃趙周吳徐孫朱馬胡郭林何高梁鄭羅宋謝唐韓曹許鄧蕭馮曾潘蔡蔣袁於杜葉蘇魏呂丁沈姜範盧賈傅鐘白汪錢廖湯文嚴石黎薛金滕康田顧孟方尹江史'.split('');
  const givenA = '小大中安宥冠柏哲孟家雅怡佩芯孟志庭宸思凱承博俊品語彤婉筑妍筠苑昀偉敏芳麗傑勇華靜亮慧欣濤磊丹凱娜康秀傑浩琳楠剛宏宇寧萍潔鵬燕遠娟毅強暉玲兵紅明偉俊靜慧萍莉文宇琪琳佳偉濤霞燕剛鳳傑勇敏敏靜磊丹凱楠娜宏宇寧萍潔鵬遠娟毅強暉玲兵紅'.split('');
  const givenB = '明偉豪霖諾瑜欣柔雯瑜庭賢傑瑋均蓉華潔媛婷潔安甄翔宇洋恩熒雲淇偉敏芳麗傑勇華靜亮慧欣濤磊丹凱娜康秀傑浩琳楠剛宏宇寧萍潔鵬燕遠娟毅強暉玲兵紅明偉俊靜慧萍莉文宇琪琳佳偉濤霞燕剛鳳傑勇敏敏靜磊丹凱楠娜宏宇寧萍潔鵬遠娟毅強暉玲兵紅'.split('');
  function randName(){ return pick(lastNames) + pick(givenA) + pick(givenB); }

  // 層級定義與 id prefix（與你現有圖例相容）
  const levelOrder = ['ROOT','經銷商','高級','中級','初級','一般'];
  const prefixByLevel = { ROOT:'ROOT', 經銷商:'CEO', 高級:'R', 中級:'T', 初級:'M', 一般:'U' };

  // 依層給下一層候選與分支範圍鍵
  function childrenPlan(level){
    switch(level){
      case '經銷商': return { next: ['經銷商','高級','中級'], key:'dealer' };
      case '高級':   return { next: ['高級','中級','初級'], key:'senior' };
      case '中級':   return { next: ['中級','初級','一般'], key:'mid' };
      case '初級':   return { next: ['初級','一般'],        key:'junior' };
      case '一般':   return { next: [],               key:null };
      default:       return { next: [],               key:null };
    }
  }

  // 產生節點
  function makeNode(level){
    const id = nextId(prefixByLevel[level] || 'N');
    const name = randName(); 
    const node = { id, name, level, metrics: { order:0, pickup:0 }, order:0, pickup:0, 訂貨:0, 提貨:0 };
    return node;
  }

  // 產生績效（訂貨、提貨），確保提貨 ≤ 訂貨
  function drawMetrics(level){
    const conf = perfByLevel[level] || { order:[0,0], pickupRatio:[0,0] };
    const order = randInt(conf.order[0], conf.order[1]);
    const ratio = Math.max(0, Math.min(1, randFloat(conf.pickupRatio[0], conf.pickupRatio[1])));
    const pickup = Math.min(order, Math.round(order * ratio));
    return { order, pickup };
  }

  // 建樹
  const root = { id:'ROOT', name:'ROOT', level:'ROOT', metrics:{ order:0, pickup:0 }, order:0, pickup:0, 訂貨:0, 提貨:0, children:[] };
  const perfProfile = { [root.id]: { order:0, pickup:0 } };

  // 先放 dealers
  for(let i=0;i<dealers;i++){
    const dealer = makeNode('經銷商');
    const m = drawMetrics('經銷商');
    dealer.metrics = m; dealer.order = m.order; dealer.pickup = m.pickup; dealer['訂貨']=m.order; dealer['提貨']=m.pickup;
    (root.children||(root.children=[])).push(dealer);
    perfProfile[dealer.id] = { ...m };
  }

  // BFS 擴展到指定深度
  const queue = [...root.children.map(n => ({ node:n, depth:2 }))]; // ROOT=1 層，經銷商=2 層
  while(queue.length){
    const { node, depth: d } = queue.shift();
    if(d >= depth) continue;

    const plan = childrenPlan(node.level);
    if(!plan.key) continue;

    const [minB, maxB] = branching[plan.key] || [0,0];
    const childCount = randInt(minB, maxB);
    if(childCount<=0) continue;

    node.children = [];
    for(let i=0;i<childCount;i++){
      const nextLevel = pick(plan.next); // 混合下一層級，避免太整齊
      const child = makeNode(nextLevel);
      const m = drawMetrics(nextLevel);
      child.metrics = m; child.order = m.order; child.pickup = m.pickup; child['訂貨']=m.order; child['提貨']=m.pickup;
      node.children.push(child);
      perfProfile[child.id] = { ...m };
      queue.push({ node: child, depth: d+1 });
    }
  }

  return { treeData: root, perfProfile, seed };
}

// ======= 預設生成一棵，讓外部直接使用 =======
const { treeData, perfProfile, seed } = generateOrgTree({
  seed: 'demo-2025-08-24',
  dealers: 3,
  depth: 10,
});

// 掛到 window，方便 D3 與 DevTools 使用
if (typeof window !== 'undefined') {
  window.treeData = treeData;        // D3 用這個
  window.perfProfile = perfProfile;  // 若需查單點績效
  window.generateOrgTree = generateOrgTree;
}

// =======（可選）重新生成 + 觸發外部 rerender =======
function regenerateAndRerender(updateFn, userOpts = {}){
  const result = generateOrgTree(userOpts);
  if (typeof window !== 'undefined') {
    window.treeData = result.treeData;
    window.perfProfile = result.perfProfile;
  }
  if (typeof updateFn === 'function') updateFn(result.treeData, result.perfProfile);
  return result;
}

    const memberJoinedAt = {
      CEO001: '2023-01-01',
      R001: '2024-03-15',
      // ... 其餘成員
    };
    
    window.DataProvider = {
      async getTreeRoot(){ return structuredClone(treeData); },
      async getPerf(ids,s,e){
        const d1=new Date(s), d2=new Date(e);
        const months=Math.max(1,(d2.getFullYear()-d1.getFullYear())*12+(d2.getMonth()-d1.getMonth())+1);
        const map = {};
        for (const id of ids){
          const avg = perfProfile[id] || {order:0,pickup:0};
          const orders=Math.round(avg.order);   // 或 * months，看你要顯示總額還是月均
          const pickup=Math.round(avg.pickup);
          map[id] = { orders, pickup, months };
        }
        return map;
      }
    };
  </script>

  <script>
    const { getTreeRoot, getPerf } = window.DataProvider;
    let root, treeLayout, g;
    let currentStart='2025-01-01', currentEnd='2025-08-15';
    const perfCache=new Map();

    // 自適應尺寸
    const margin = {top:120,right:40,bottom:40,left:40};

    const svg = d3.select('#chart').append('svg')
      .attr('preserveAspectRatio','xMidYMid meet');

    const zoomLayer = svg.append('g');
    g = zoomLayer.append('g'); // transform 由 applySize 設

    function applySize(){
      const el = document.getElementById('chart');
      const W  = el.clientWidth;
      const H  = Math.max(500, Math.floor(window.innerHeight * 0.7)); // 70% 視窗高，至少 500
      svg.attr('viewBox', [0, 0, W, H].join(' '));
      g.attr('transform', `translate(${margin.left},${margin.top})`);
    }
    applySize();
    window.addEventListener('resize', () => { applySize(); fitToContentTop(); });

    // 取目前 viewBox 尺寸
    function vbSize(){
      const [ , , W, H ] = svg.attr('viewBox').split(' ').map(Number);
      return { W, H };
    }

    //treeLayout = d3.tree().size([width, height]);
    //可調間距
    const XGAP = 100;   // 同層左右間距
    const YGAP = 120;   // 父子垂直距離
    treeLayout = d3.tree()
      .nodeSize([XGAP, YGAP])
      .separation((a,b)=> (a.parent === b.parent ? 1.2 : 1.8));

    // Zoom 行為
    const zoom = d3.zoom()
      .scaleExtent([0.3, 2])
      .on('zoom', (ev)=>{
        zoomLayer.attr('transform', ev.transform);
        const k = ev.transform.k;
        d3.selectAll('.orders-text,.pickup-text').style('display', k >= 1.0 ? null : 'none');
        d3.selectAll('.level-text').style('display',  k >= 0.8 ? null : 'none');
        // 姓名永遠顯示
      });

    svg.call(zoom).on('dblclick.zoom', null);   // 關掉雙擊放大（避免誤觸）
    
    // const svg=d3.select('#chart').append('svg')
      //.attr('width',width+margin.left+margin.right)
      //.attr('height',height+margin.top+margin.bottom);
    //g=svg.append('g').attr('transform',`translate(${margin.left},${margin.top})`);
    //treeLayout=d3.tree().size([width,height]);
    const HIGH_THRESHOLD = 106;

    // === 事件 ===
    document.getElementById('btnApply').addEventListener('click',()=>{
      const s=startDate.value, e=endDate.value;
      if(!s||!e) return alert('請選擇完整的日期區間');
      if(new Date(s)>new Date(e)) return alert('開始日期不能晚於結束日期');
      currentStart=s; currentEnd=e;
      refreshVisiblePerf().then(()=>{ update(root); updateSummary(); });
    });

    document.getElementById('btnSearch').addEventListener('click', ()=>{ applySearch(); });
    document.getElementById('btnClear').addEventListener('click', ()=>{
      highlightIds=null; update(root); updateSummary();
    });

    // === 初始化 ===
    init();
    async function init(){
      const data=await getTreeRoot();
      root=d3.hierarchy(data,d=>d.children);
      if (root.children) {
        root.children.forEach(collapse);  // 將經銷商的子孫折疊到 _children
      }

      const { W } = vbSize();
      root.x0 = W/2; root.y0 = 0;
      
      await refreshVisiblePerf();
      update(root);
      updateSummary(); 
    }


    
    // 置中（水平）＋貼上方（垂直），自動縮放到看得下
    function fitToContentTop() {
      const node = g.node();
      if (!node) return;

     const b = node.getBBox();
      if (!isFinite(b.width) || !isFinite(b.height) || b.width === 0 || b.height === 0) {
        svg.transition().duration(250).call(zoom.transform, d3.zoomIdentity);
        return;
      }

      const [ , , fullW, fullH ] = svg.attr('viewBox').split(' ').map(Number);

      const FIT_PADDING_TOP = 30;   // 上方留白（越大越往下）
      const FIT_PADDING     = 48;   // 左右/下方留白
      const FIT_BUMP        = 1.6;  // 初始放大一點點（>1 會更近，<1 會更遠） 
      const ZOOM_MIN        = 0.4;  // 允許最小縮放
      const ZOOM_MAX        = 2.5;  // 允許最大縮放
      
      // 先用真正 fit 算出 baseScale，再乘上 BUMP 讓比例更大些
      const baseScale = Math.min(
        (fullW - FIT_PADDING * 2) / b.width,
        (fullH - (FIT_PADDING_TOP + FIT_PADDING)) / b.height
      );
      const k = Math.max(ZOOM_MIN, Math.min(ZOOM_MAX, baseScale * FIT_BUMP));

      // ★ 用「內容中心對齊視窗中心」的方式算水平位移，避免偏左
      const contentCx = b.x + b.width / 2 + margin.left;
      const tx = (fullW / 2) - (contentCx * k);
      const ty = FIT_PADDING_TOP - (b.y + margin.top * k);

      svg.transition().duration(500)
         .call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(k));
    }

    // 讓拖曳時有「抓取」游標
    svg.on('mousedown', ()=> svg.classed('grabbing', true));
    d3.select(window).on('mouseup', ()=> svg.classed('grabbing', false));

    // 控制鈕
    d3.select('#btnZoomIn') .on('click', ()=> svg.transition().duration(200).call(zoom.scaleBy, 1.2));
    d3.select('#btnZoomOut').on('click', ()=> svg.transition().duration(200).call(zoom.scaleBy, 1/1.2));
    d3.select('#btnFit')    .on('click', ()=> fitToContentTop());

    let searchKeyword = ''; // 你現有的搜尋字串

    d3.select('#searchName').on('input', function(){
      searchKeyword = this.value.trim();
      update(root);
    });

    d3.select('#btn-expand').on('click', async () => {
      if (!root) return;
      const kw = searchKeyword.trim();
      if (!kw) return;

      const matches = root.descendants().filter(n => (n.data.name || '').includes(kw));
      matches.forEach(n => { expandAncestors(n); expandSubtree(n); });

      await refreshVisiblePerf();
      update(root);
      fitToContentTop(); 
      updateSummary();
    });
        
    // 畫面更新後(展開/收合/搜尋)也可自動 fit（選擇性）
    function afterUpdateAutoFit(){
      fitToContentTop();
    }
    
    function collapse(n){ if(n.children){ n._children=n.children; n._children.forEach(collapse); n.children=null; } }
    function isHighPerformer(d){
      return (d?.data?.order ?? 0) >= HIGH_THRESHOLD;
    }
    function levelFill(l){ if(l==='經銷商')return'#5582b4'; if(l==='高級'||l==='中級'||l==='初級')return'#f7959d'; if(l==='一般')return'#deabe9'; return'#ccc'; }
    function levelStroke(l){ if(l==='經銷商')return'#3f668e'; if(l==='高級'||l==='中級'||l==='初級')return'#d86a74'; if(l==='一般')return'#b687c8'; return'#999'; }

    // 依 D3 常見折疊模式：children 可見，_children 折疊
    function expandNode(d){
      if (d._children){ d.children = d._children; d._children = null; }
    }
    function expandAncestors(d){
      let p = d;
      while (p){ expandNode(p); p = p.parent; }
    }
    function expandSubtree(d){
      expandNode(d);
      if (d.children) d.children.forEach(expandSubtree);
    }

    // 只收集目前可見節點（展開中的）
    function collectVisible(n,out){ if(n.depth>0) out.push(n); if(n.children) n.children.forEach(c=>collectVisible(c,out)); }
    function getVisibleNodes(){ const arr=[]; collectVisible(root,arr); return arr; }

    async function refreshVisiblePerf(){
      treeLayout(root);
      const visible=getVisibleNodes();
      const ids=visible.map(n=>n.data.id);
      const key=id=>`${id}|${currentStart}|${currentEnd}`;
      const need=ids.filter(id=>!perfCache.has(key(id)));
      if(need.length){
        const map=await getPerf(need,currentStart,currentEnd);
        for(const id of need) perfCache.set(key(id), map[id]||{orders:0,pickup:0,months:1});
      }
      for(const n of visible) n.data.performance=perfCache.get(key(n.data.id));
    }

    // ===== 搜尋：命中者的所有祖先 + 所有子孫（未被淡化者保留） =====
    let highlightIds=null; // Set<string>|null
    function applySearch(){
      const q=(searchName.value||'').trim();
      if(!q){ highlightIds=null; update(root); updateSummary(); return; }

      // 建索引（含未展開子孫）
      const all=[]; (function walk(n){ all.push(n); (n.children||[]).forEach(walk); (n._children||[]).forEach(walk); })(root);
      const hits=all.filter(n=> (n.data.name||'').includes(q));
      if(!hits.length){ highlightIds=new Set(); update(root); updateSummary(); return; }

      const keep=new Set();
      const addAnc=(n)=>{ let cur=n; while(cur){ keep.add(cur.data.id); cur=cur.parent; } };
      const addDesc=(n)=>{ (function dfs(x){ keep.add(x.data.id); (x.children||[]).forEach(dfs); (x._children||[]).forEach(dfs); })(n); };
      for(const h of hits){ addAnc(h); addDesc(h); }
      keep.delete('ROOT');
      highlightIds=keep;
      update(root); updateSummary();
    }
    const shouldDim=(d)=>{ if(!highlightIds) return false; return !highlightIds.has(d.data.id); };

    const topAncestorId=(n)=>{ let cur=n; while(cur.parent && cur.parent.depth>0) cur=cur.parent; return cur.data.id; };

    let firstPaint = true;  // 首次繪製
    function update(source){
      treeLayout(root);
      const nodes=getVisibleNodes();
      nodes.forEach(d => { d.topId = topAncestorId(d); });
      const dur = firstPaint ? 0 : 600;   // 第一次不要動畫

      // 不畫虛擬 ROOT 的連線
      const links=nodes.filter(d=>d.parent && d.parent.depth>0);

      const node=g.selectAll('.node').data(nodes, d=>d.data.id);
      const enter=node.enter().append('g').attr('class','node')
        // 第一次直接放在目標座標；其後才從 source 位置動畫到目標
        .attr('transform', d=> firstPaint
          ? `translate(${d.x},${d.y})`
          : `translate(${source.x0||0},${source.y0||0})`)
        .on('click', async (evt,d)=>{ toggle(d); await refreshVisiblePerf(); update(d); updateSummary(); });

      enter.append('circle').attr('r',8);
      enter.append('text').attr('class','name-text').attr('dy','-2.5em').text(d=>d.data.name);
      enter.append('text').attr('class','level-text').attr('dy','-1.2em').text(d=>d.data.level||'');
     
      // 建立「訂貨」文字 //
      enter.append('text')
        .attr('class', 'orders-text')
        .attr('dy', '1.8em')
        .text(d => `訂貨：${Math.round(d.data.order || 0)}萬`);

      // 建立「提貨」文字 //
      enter.append('text')
        .attr('class', 'pickup-text')
        .attr('dy', '3.0em')
        .text(d => `提貨：${Math.round(d.data.pickup || 0)}萬`);

      const merged=enter.merge(node);
      merged.transition().duration(dur).attr('transform', d=>`translate(${d.x},${d.y})`);
      merged.select('circle')
        .attr('r',8)
        .style('fill', d=>levelFill(d.data.level))
        .style('stroke-width', d=>isHighPerformer(d)?3:2)
        .style('stroke', d=>isHighPerformer(d)?'#fff600':levelStroke(d.data.level));
  
      // 更新「訂貨」 //
      merged.select('.orders-text')
       .text(d => `訂貨：${Math.round(d.data.order || 0)}萬`);

      // 更新「提貨」 //
      merged.select('.pickup-text')
        .text(d => `提貨：${Math.round(d.data.pickup || 0)}萬`);
      
      merged.style('opacity', d=> shouldDim(d)? .3 : 1);

      node.exit().transition().duration(400)
        .attr('transform', d=>`translate(${source.x||0},${source.y||0})`).remove();

      const link=g.selectAll('.link').data(links, d=>d.data.id);
      const linkEnter=link.enter().insert('path','g').attr('class','link')
        .attr('d', d=> firstPaint ? diagonal(d,d.parent)
          : diagonal({x:source.x0||0,y:source.y0||0}, {x:source.x0||0,y:source.y0||0}));
      linkEnter.merge(link).transition().duration(dur)
        .attr('d', d=> diagonal(d,d.parent))
        .style('opacity', d=> {
          if(!highlightIds) return 1;
          return (highlightIds.has(d.data.id) && highlightIds.has(d.parent.data.id)) ? 1 : .5;
        });
      link.exit().transition().duration(400)
        .attr('d', d=>{ const o={x:source.x||0,y:source.y||0}; return diagonal(o,o); }).remove();

      nodes.forEach(d=>{ d.x0=d.x; d.y0=d.y; });

      // 第一次畫完就立即 fit（無動畫），之後就保持原本流程
      if (firstPaint) {
        fitToContentTop();
        firstPaint = false;
        }
      }

    function toggle(d){
      if(d.children){ d._children=d.children; d._children.forEach(collapse); d.children=null; }
      else { d.children=d._children; d._children=null; }
    }
    function diagonal(s,d){ return `M ${s.x} ${s.y} C ${s.x} ${(s.y+d.y)/2}, ${d.x} ${(s.y+d.y)/2}, ${d.x} ${d.y}`; }

    // === 摘要：無搜尋→所有可見；有搜尋→未半透明 ===
    function updateSummary(){
      let nodes=getVisibleNodes();
      if (highlightIds) nodes = nodes.filter(d => !shouldDim(d));

      let totalOrders=0,totalPickup=0,totalMembers=0,high=0;
      
      for(const n of nodes){
        if(n.depth===0) continue;
        totalMembers++;
        
        const order  = n.data.order  ?? n.data.metrics?.order  ?? 0;
        const pickup = n.data.pickup ?? n.data.metrics?.pickup ?? 0;

        totalOrders += order;
        totalPickup += pickup;

        if (order >= HIGH_THRESHOLD) high++;   // HIGH_THRESHOLD 單位：萬
      }
      
      document.getElementById('totalOrders').textContent=totalOrders.toLocaleString();
      document.getElementById('totalPickup').textContent=totalPickup.toLocaleString();
      document.getElementById('totalMembers').textContent=totalMembers;
      document.getElementById('highPerformers').textContent=high;
    }
  </script>
</body>
</html>
