<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çµ„ç¹”æ¶æ§‹åœ– MVP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <style>
    :root { --bg:#f5f6fa; --card:#fff; --ink:#2c3e50; --muted:#7f8c8d; --pri:#3498db; --pri-2:#2980b9; --hi:#f39c12; --hi-2:#e67e22; --warn:#e74c3c; --warn-2:#c0392b; }
    * { box-sizing:border-box }
    body { margin:0; font-family:'Microsoft JhengHei', system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg) }
    .container { max-width:1400px; margin:16px auto; background:var(--card); border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,.08); overflow:hidden }
    .header { position:relative; padding:20px; color:#fff; background:linear-gradient(135deg,#2c3e50 0%,#3498db 100%) }
    .header h1 { margin:0 0 6px; font-size:22px }
    .header p { margin:0; opacity:.9 }
    .date-filter { position:absolute; top:16px; right:16px; display:flex; gap:6px; flex-wrap:wrap; align-items:center; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); backdrop-filter:blur(10px); border-radius:10px; padding:10px }
    .date-filter label { font-size:12px; font-weight:700 }
    .date-filter input { width:135px; padding:8px; border:none; border-radius:6px; background:rgba(255,255,255,.95); font-size:12px }
    .date-filter button { padding:8px 12px; border:none; border-radius:6px; background:#27ae60; color:#fff; font-size:12px; cursor:pointer }
    .date-filter button:hover { filter:brightness(.95) }
    .chart-container { padding:16px; text-align:center }
    .instructions { background:linear-gradient(135deg,#e8f5e8 0%,#f0f8ff 100%); border:1px solid #27ae60; color:var(--ink); padding:12px; border-radius:10px; margin:0 0 12px }
    .legend { display:flex; justify-content:center; gap:18px; flex-wrap:wrap; padding:12px; background:#f8f9fa; border-radius:10px }
    .legend-item { display:flex; align-items:center; gap:8px; font-size:12px }
    .legend-circle { width:12px; height:12px; border-radius:50%; border:2px solid }
    .legend-normal { background:#deabe9; border-color:#b687c8 }
    .legend-collapsed { background:var(--warn); border-color:var(--warn-2) }
    .legend-high { background:var(--hi); border-color:var(--hi-2) }
    .stats-summary { display:flex; justify-content:space-around; gap:8px; flex-wrap:wrap; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:14px; border-radius:10px; margin-top:12px }
    .stat-item { text-align:center }
    .stat-value { font-size:22px; font-weight:800; display:block }
    .stat-label { font-size:12px; opacity:.9 }
    .node-group { cursor:pointer }
    .node circle { stroke-width:2px; transition:all .25s ease }
    .node circle:hover { transform:scale(1.08) }
    .node text { fill:var(--ink); text-anchor:middle; pointer-events:none }
    .node .name-text { font-weight:700; font-size:14px; dominant-baseline:middle }
    .node .level-text { font-size:11px; fill:var(--muted); dominant-baseline:middle }
    .node .orders-text { font-size:10px; fill:#27ae60; font-weight:700; dominant-baseline:middle }
    .node .pickup-text { font-size:10px; fill:#8e44ad; font-weight:700; dominant-baseline:middle }
    .link { fill:none; stroke:#bdc3c7; stroke-width:2px; stroke-opacity:.85 }
    @media (max-width: 768px){ .date-filter{ position:relative; top:auto; right:auto; margin-top:10px } .header h1{ font-size:18px } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>çµ„ç¹”æ¶æ§‹åœ–</h1>
      <p>é»æ“Šç¯€é»å±•é–‹ä¸‹ç·šçµ„ç¹”ï¼ŒæŸ¥çœ‹å„éšæ®µæ¥­ç¸¾è¡¨ç¾</p>
      <div class="date-filter">
        <label>ç¯©é¸æœŸé–“</label>
        <input type="date" id="startDate" value="2025-01-01" />
        <input type="date" id="endDate" value="2025-08-15" />
        <button id="btnApply">æ›´æ–°æ•¸æ“š</button>
      </div>
    </div>

    <div class="chart-container">
      <div class="instructions">ğŸ“Š é¸æ“‡æ—¥æœŸå€é–“æŸ¥çœ‹å„éšå±¤æ¥­ç¸¾ | ğŸ”µ ä¸€èˆ¬æœƒå“¡(ç¤ºä¾‹è‰²) | ğŸ”´ å·²æ”¶ç¸®ç¯€é» | ğŸŸ¡ é«˜æ¥­ç¸¾æœƒå“¡ (æœˆè¨‚è²¨ â‰¥ 50è¬)</div>
      <div id="chart"></div>
      <div class="stats-summary">
        <div class="stat-item"><span class="stat-value" id="totalOrders">0</span><span class="stat-label">ç¸½è¨‚è²¨é‡‘é¡ (è¬å…ƒ)</span></div>
        <div class="stat-item"><span class="stat-value" id="totalPickup">0</span><span class="stat-label">ç¸½æè²¨é‡‘é¡ (è¬å…ƒ)</span></div>
        <div class="stat-item"><span class="stat-value" id="totalMembers">0</span><span class="stat-label">çµ„ç¹”ç¸½äººæ•¸</span></div>
        <div class="stat-item"><span class="stat-value" id="highPerformers">0</span><span class="stat-label">é«˜æ¥­ç¸¾æœƒå“¡</span></div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-circle" style="background:#5582b4;border-color:#3f668e"></div><span>ç¶“éŠ·å•†</span></div>
        <div class="legend-item"><div class="legend-circle" style="background:#f7959d;border-color:#d86a74"></div><span>é«˜ç´š / ä¸­ç´š / åˆç´š</span></div>
        <div class="legend-item"><div class="legend-circle legend-normal"></div><span>ä¸€èˆ¬</span></div>
        <div class="legend-item"><div class="legend-circle legend-high"></div><span>é«˜æ¥­ç¸¾</span></div>
        <div class="legend-item"><div class="legend-circle legend-collapsed"></div><span>å·²æ”¶ç¸®</span></div>
      </div>
    </div>
  </div>

  <!-- Data layer (mock) æ›åˆ° window æ–¹ä¾¿éƒ¨ç½²åœ¨ GitHub Pages -->
  <script>
    // ====== è™›æ“¬ ROOTï¼Œåº•ä¸‹å…©æ¢ä¸»ç·šï¼šæ—åŸ·è¡Œé•·ã€ç‹è¶…äºº ======
    const treeData = {
      id: 'ROOT', name: 'ROOT', level: 'ROOT', children: [
        {
          id:'CEO001', name:'æ—åŸ·è¡Œé•·', level:'ç¶“éŠ·å•†', children:[
            { id:'R001', name:'ç‹å€åŸŸç¸½ç›£', level:'é«˜ç´š', children:[
              { id:'T001', name:'æçµ„é•·', level:'ä¸­ç´š', children:[
                { id:'M001', name:'é™³å°ç¾', level:'ä¸€èˆ¬' },
                { id:'M002', name:'å¼µå¿—æ˜', level:'ä¸€èˆ¬' },
                { id:'M008', name:'ä¾¯é›…æ…§', level:'åˆç´š' }
              ]},
              { id:'T002', name:'é»ƒä¸»ä»»', level:'ä¸­ç´š', children:[
                { id:'M003', name:'åŠ‰å¤§å‰', level:'ä¸€èˆ¬' },
                { id:'M004', name:'å‘¨ç¾éº—', level:'åˆç´š' },
                { id:'M009', name:'æ—äº­å®‰', level:'ä¸€èˆ¬' }
              ]}
            ]},
            { id:'R002', name:'è¶™å€åŸŸç¸½ç›£', level:'é«˜ç´š', children:[
              { id:'T003', name:'å³çµ„é•·', level:'ä¸­ç´š', children:[
                { id:'M005', name:'é¦®å°å¼·', level:'ä¸€èˆ¬' },
                { id:'M006', name:'è”¡é›…å©·', level:'åˆç´š' }
              ]},
              { id:'T004', name:'è¨±ä¸»ä»»', level:'åˆç´š', children:[
                { id:'M007', name:'è¬å°èŠ¬', level:'ä¸€èˆ¬' },
                { id:'M010', name:'æ¥Šä¿¡å®', level:'ä¸€èˆ¬' }
              ]}
            ]}
          ]
        },
        {
          id:'LEAD200', name:'ç‹è¶…äºº', level:'ç¶“éŠ·å•†', children:[
            { id:'R101', name:'é™³é£›ä¿ ', level:'é«˜ç´š', children:[
              { id:'T101', name:'é«˜å°é¾', level:'ä¸­ç´š', children:[
                { id:'U001', name:'æ—å°è™', level:'ä¸€èˆ¬' },
                { id:'U002', name:'å½­ç¾çª', level:'ä¸€èˆ¬' },
                { id:'U003', name:'å®‹æ¹˜æ€¡', level:'åˆç´š' }
              ]},
              { id:'T102', name:'æ›¾æ˜æ…§', level:'åˆç´š', children:[
                { id:'U004', name:'æœæ€å¦¤', level:'ä¸€èˆ¬' },
                { id:'U005', name:'é­å®¶è±ª', level:'ä¸€èˆ¬' }
              ]}
            ]},
            { id:'R102', name:'å¼µå®‡å®™', level:'ä¸­ç´š', children:[
              { id:'T103', name:'ä½•é’é’', level:'åˆç´š', children:[
                { id:'U006', name:'é‚±æŸç¿°', level:'ä¸€èˆ¬' },
                { id:'U007', name:'é€£èªç³', level:'ä¸€èˆ¬' }
              ]},
              { id:'T104', name:'è³´æ€æ€', level:'ä¸­ç´š', children:[
                { id:'U008', name:'éŸ“å¯æ¬£', level:'åˆç´š' },
                { id:'U009', name:'æŸ¯å“²ç‘‹', level:'ä¸€èˆ¬' },
                { id:'U010', name:'ç°¡éŠ˜æ˜Œ', level:'ä¸€èˆ¬' }
              ]}
            ]}
          ]
        }
      ]
    };

    // æ¯æœˆå¹³å‡è¨‚è²¨(è¬)
    const perfProfile = {
      CEO001: 420, R001: 180, T001: 95, M001: 48, M002: 26, M008: 32,
      T002: 75,  M003: 22,  M004: 38, M009: 28,
      R002: 130, T003: 70,  M005: 31, M006: 14,
      T004: 58,  M007: 18, M010: 20,
      LEAD200: 400, R101: 170, T101: 92, U001: 40, U002: 36, U003: 30,
      T102: 55,  U004: 22,  U005: 24,
      R102: 110, T103: 60,  U006: 26, U007: 20,
      T104: 78,  U008: 28,  U009: 35, U010: 33
    };

    // å°å¤– APIï¼ˆä¹‹å¾Œæ¥å¾Œç«¯æ™‚ä¿ç•™å‡½å¼ç°½åï¼‰
    window.DataProvider = {
      async getTreeRoot(){ return structuredClone(treeData); },
      async getChildren(parent){ return parent.children || []; },
      async getPerf(memberIds, startDate, endDate){
        const d1 = new Date(startDate), d2 = new Date(endDate);
        const months = Math.max(1, (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth()) + 1);
        const map = {};
        for(const id of memberIds){
          const avg = perfProfile[id] || 0;
          const orders = Math.round(avg * months);
          const pickup = Math.round(orders * 0.95);
          map[id] = { orders, pickup, months };
        }
        return map;
      },
      async getLevelsAt(memberIds, endTs){
        const lvMap = {}; (function walk(n){ lvMap[n.id]=n.level; (n.children||[]).forEach(walk); })(treeData);
        const out = {}; for(const id of memberIds) out[id]=lvMap[id]||""; return out;
      }
    };
  </script>

  <!-- App -->
  <script>
    const { getTreeRoot, getPerf } = window.DataProvider;

    // ====== State ======
    let root, treeLayout, g, i=0;
    let currentStart = '2025-01-01';
    let currentEnd   = '2025-08-15';
    const perfCache = new Map(); // key: id|d1|d2 -> {orders,pickup,months}

    // ====== SVGï¼ˆæé«˜ä¸Šé‚Šè·é¿å…é ‚éƒ¨æˆªæ‰ï¼‰ ======
    const margin = {top:120,right:40,bottom:40,left:40};
    const width  = 1200 - margin.left - margin.right;
    const height = 800  - margin.top  - margin.bottom;
    const svg = d3.select('#chart').append('svg')
      .attr('width', width + margin.left + margin.right)
      .attr('height', height + margin.top + margin.bottom);
    g = svg.append('g').attr('transform',`translate(${margin.left},${margin.top})`);
    treeLayout = d3.tree().size([width, height]);

    document.getElementById('btnApply').addEventListener('click', () => {
      const s = (document.getElementById('startDate')).value;
      const e = (document.getElementById('endDate')).value;
      if(!s||!e) return alert('è«‹é¸æ“‡å®Œæ•´çš„æ—¥æœŸå€é–“');
      if(new Date(s) > new Date(e)) return alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
      currentStart = s; currentEnd = e; refreshVisiblePerf().then(()=>{ update(root); updateSummary(); });
    });

    init();

    async function init(){
      const data = await getTreeRoot();
      root = d3.hierarchy(data, d => d.children);
      // æ”¶åˆ ROOT çš„å­å­«ç¯€é»
      root.children?.forEach(collapse);
      root.x0 = width/2; root.y0 = 0;
      await refreshVisiblePerf();
      update(root);
      updateSummary();
    }

    function collapse(d){ if(d.children){ d._children=d.children; d._children.forEach(collapse); d.children=null; } }

    function isHighPerformer(d){ const p=d.data.performance; return p && p.months && (p.orders/p.months) >= 50; }

    function levelFill(level){
      if(level==='ç¶“éŠ·å•†') return '#5582b4';
      if(level==='é«˜ç´š' || level==='ä¸­ç´š' || level==='åˆç´š') return '#f7959d';
      if(level==='ä¸€èˆ¬') return '#deabe9';
      return '#3498db';
    }
    function levelStroke(level){
      if(level==='ç¶“éŠ·å•†') return '#3f668e';
      if(level==='é«˜ç´š' || level==='ä¸­ç´š' || level==='åˆç´š') return '#d86a74';
      if(level==='ä¸€èˆ¬') return '#b687c8';
      return '#2980b9';
    }

    async function refreshVisiblePerf(){
      const nodesAll = treeLayout(root).descendants();
      const nodes = nodesAll.filter(n => n.depth > 0); // éš±è—è™›æ“¬ ROOT
      const visible = nodes.map(n=>n.data.id);
      const keyOf = id => `${id}|${currentStart}|${currentEnd}`;
      const need = visible.filter(id => !perfCache.has(keyOf(id)));
      if(need.length){
        const map = await getPerf(need, currentStart, currentEnd);
        for(const id of need){ perfCache.set(keyOf(id), map[id] || {orders:0,pickup:0,months:1}); }
      }
      for(const n of nodes){ const k=keyOf(n.data.id); n.data.performance = perfCache.get(k) || {orders:0,pickup:0,months:1}; }
    }

    function update(source){
      const treeData = treeLayout(root);
      const nodesAll = treeData.descendants();
      const nodes = nodesAll.filter(n => n.depth > 0); // ä¸ç•«è™›æ“¬ ROOT
      const links = nodes.filter(d => d.parent && d.parent.depth > 0);
      nodes.forEach(d => d.y = d.depth * 150);

      const node = g.selectAll('.node').data(nodes, d => d.id || (d.id=++i));
      const enter = node.enter().append('g')
        .attr('class','node')
        .attr('transform', d=>`translate(${source.x0||0},${source.y0||0})`)
        .on('click', async (event,d)=>{ toggle(d); await refreshVisiblePerf(); update(d); updateSummary(); });

      enter.append('circle').attr('r',1e-6);
      enter.append('text').attr('class','name-text').attr('dy','-2.5em').text(d=>d.data.name);
      enter.append('text').attr('class','level-text').attr('dy','-1.2em').text(d=>d.data.level||'');
      enter.append('text').attr('class','orders-text').attr('dy','1.8em').text(d=>`è¨‚è²¨: ${(d.data.performance?.orders||0)}è¬`);
      enter.append('text').attr('class','pickup-text').attr('dy','3.0em').text(d=>`æè²¨: ${(d.data.performance?.pickup||0)}è¬`);

      const updateSel = enter.merge(node);
      updateSel.transition().duration(600).attr('transform', d=>`translate(${d.x},${d.y})`);
      updateSel.select('circle')
        .attr('r',8)
        .style('fill', d=> d._children? '#e74c3c' : levelFill(d.data.level))
        .style('stroke-width', d=> isHighPerformer(d)? 3:2)
        .style('stroke', d=> d._children? '#c0392b' : isHighPerformer(d)? '#e67e22' : levelStroke(d.data.level));

      updateSel.select('.orders-text').text(d=>`è¨‚è²¨: ${(d.data.performance?.orders||0)}è¬`);
      updateSel.select('.pickup-text').text(d=>`æè²¨: ${(d.data.performance?.pickup||0)}è¬`);

      const exit = node.exit().transition().duration(600)
        .attr('transform', d=>`translate(${source.x||0},${source.y||0})`).remove();
      exit.select('circle').attr('r',1e-6); exit.select('text').style('fill-opacity',1e-6);

      const link = g.selectAll('.link').data(links, d=>d.id);
      const linkEnter = link.enter().insert('path','g').attr('class','link')
        .attr('d', d=> { const o={x:source.x0||0,y:source.y0||0}; return diagonal(o,o); });
      linkEnter.merge(link).transition().duration(600).attr('d', d=> diagonal(d,d.parent));
      link.exit().transition().duration(600).attr('d', d=>{ const o={x:source.x||0,y:source.y||0}; return diagonal(o,o); }).remove();

      nodes.forEach(d=>{ d.x0=d.x; d.y0=d.y; });
    }

    function toggle(d){ if(d.children){ d._children=d.children; d.children=null; } else { d.children=d._children; d._children=null; } }

    function diagonal(s,d){
      return `M ${s.x} ${s.y} C ${s.x} ${(s.y+d.y)/2}, ${d.x} ${(s.y+d.y)/2}, ${d.x} ${d.y}`;
    }

    function updateSummary(){
      let totalOrders=0, totalPickup=0, totalMembers=0, high=0;
      (function walk(n){
        (n.children||n._children||[]).forEach(walk);
        if(n.depth===0) return; // å¿½ç•¥è™›æ“¬ ROOT
        totalMembers++;
        const p=n.data.performance||{orders:0,pickup:0,months:1};
        totalOrders+=p.orders; totalPickup+=p.pickup;
        if((p.orders/p.months)>=50) high++;
      })(root);
      document.getElementById('totalOrders').textContent = totalOrders.toLocaleString();
      document.getElementById('totalPickup').textContent = totalPickup.toLocaleString();
      document.getElementById('totalMembers').textContent = totalMembers;
      document.getElementById('highPerformers').textContent = high;
    }
  </script>
</body>
</html>
